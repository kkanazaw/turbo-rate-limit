<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Turbo Frame from src on GitHub Pages</title>
  <script type="module">
    import hotwiredTurbo from 'https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.13/+esm'
    import hotwiredstimulus from 'https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/+esm'
    import pQueue from 'https://cdn.jsdelivr.net/npm/p-queue@8.1.0/+esm'

    const app = Application.start()

    app.register("lazy-frame", class extends Stimulus.Controller {
      static queue = new PQueue({
        concurrency: 1,
        interval: 10000,
        intervalCap: 1,
        carryoverConcurrencyCount: true
      })

      connect() {
        this.resolve = null
      }

      onBeforeFetchRequest(event) {
        event.preventDefault()
        const resume = event.detail.resume

        this.constructor.queue.add(() => {
          console.log(`[${this.element.id}] added to queue`)
          return new Promise((resolve) => {
            this.resolve = resolve
            resume()
          })
        })
      }

      onFrameLoad(event) {
        if (event.target !== this.element) return
        this._safeResolve("loaded")
      }

      onFrameRender(event) {
        if (event.target !== this.element) return
        if (event.detail.error) {
          this._safeResolve("error")
        }
      }

      _safeResolve(status) {
        if (this.resolve) {
          console.log(`[${this.element.id}] frame ${status}`)
          this.resolve()
          this.resolve = null
        }
      }
    })
  </script>
</head>

<body>
  <h1>Turbo + Stimulus + p-queue (GitHub Pages)</h1>

  <turbo-frame
    id="frame_1"
    src="./frames/frame1.html"
    data-controller="lazy-frame"
    data-action="
      turbo:before-fetch-request->lazy-frame#onBeforeFetchRequest
      turbo:frame-load->lazy-frame#onFrameLoad
      turbo:frame-render->lazy-frame#onFrameRender"
  >
    <p>Loading frame 1...</p>
  </turbo-frame>

  <turbo-frame
    id="frame_2"
    src="./frames/frame2.html"
    data-controller="lazy-frame"
    data-action="
      turbo:before-fetch-request->lazy-frame#onBeforeFetchRequest
      turbo:frame-load->lazy-frame#onFrameLoad
      turbo:frame-render->lazy-frame#onFrameRender"
  >
    <p>Loading frame 2...</p>
  </turbo-frame>
</body>
</html>
